---
- name: Install monitoring packages
  ansible.builtin.apt:
    name: "{{ monitoring_packages }}"
    state: present
    update_cache: true

- name: Configure Prometheus
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ monitoring_prometheus_config }}"
    owner: root
    group: prometheus
    mode: "0640"
  notify: Restart prometheus

- name: Configure Blackbox Exporter
  ansible.builtin.template:
    src: blackbox-exporter.yml.j2
    dest: "{{ monitoring_blackbox_config }}"
    owner: root
    group: prometheus
    mode: "0640"
  notify: Restart prometheus-blackbox-exporter

- name: Configure Grafana
  ansible.builtin.template:
    src: grafana.ini.j2
    dest: /etc/grafana/grafana.ini
    owner: root
    group: grafana
    mode: "0644"
  notify: Restart grafana

- name: Ensure Grafana provisioning directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: grafana
    mode: "0755"
  loop:
    - /etc/grafana/provisioning/datasources
    - /etc/grafana/provisioning/dashboards
    - /var/lib/grafana/dashboards

- name: Configure Grafana datasource
  ansible.builtin.template:
    src: grafana-datasource-prometheus.yml.j2
    dest: /etc/grafana/provisioning/datasources/prometheus.yml
    owner: root
    group: grafana
    mode: "0644"
  notify: Restart grafana

- name: Configure Grafana dashboards provisioning
  ansible.builtin.template:
    src: grafana-dashboards.yml.j2
    dest: /etc/grafana/provisioning/dashboards/home-arpa.yml
    owner: root
    group: grafana
    mode: "0644"
  notify: Restart grafana

- name: Deploy Grafana dashboards
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "/var/lib/grafana/dashboards/{{ item.dest }}"
    owner: grafana
    group: grafana
    mode: "0644"
  loop: "{{ monitoring_dashboards }}"
  notify: Restart grafana

- name: Ensure monitoring services are enabled and started
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: true
    daemon_reload: true
  loop:
    - prometheus
    - prometheus-node-exporter
    - prometheus-blackbox-exporter
    - grafana-server
